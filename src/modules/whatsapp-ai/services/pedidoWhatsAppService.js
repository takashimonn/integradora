const geminiService = require('./geminiService');const clienteService = require('./clienteService');const whatsappBusinessService = require('./whatsappBusinessService');const orderService = require('../../orders/services/orderService');const productRepository = require('../../products/repositories/productRepository');const Usuario = require('../../../models/Usuario');const Sucursal = require('../../../models/Sucursal');class PedidoWhatsAppService {  async procesarYCrearPedido(mensaje, telefono, idSucursal = null) {    try {      const productosDisponibles = await productRepository.findAll();      const productosJSON = productosDisponibles.map(p => ({        id_producto: p.id_producto,        nombre: p.descripcion || 'Producto',        precio: parseFloat(p.precio)      }));      const clienteExistente = await clienteService.obtenerClientePorTelefono(telefono);      let datosPedido;      try {        datosPedido = await geminiService.procesarMensajePedido(          mensaje,          telefono,          productosJSON        );      } catch (error) {        if (error.message.includes('producto') || error.message.includes('pedido')) {          console.log('Mensaje no es un pedido vÃ¡lido, ignorando...');          try {            await whatsappBusinessService.enviarMensaje(              telefono,              'Hola! ğŸ‘‹ Para hacer un pedido, por favor menciona los productos que deseas. Por ejemplo: "Quiero 2 pollos fritos"'            );          } catch (err) {            console.warn('No se pudo enviar mensaje de respuesta:', err.message);          }          return {            success: false,            message: 'Mensaje no es un pedido vÃ¡lido',            ignorado: true          };        }        throw error;      }      if (!clienteExistente) {        const datosCliente = await geminiService.extraerDatosCliente(mensaje);        const camposFaltantes = [];        if (!datosCliente.nombre || datosCliente.nombre.trim() === '') {          camposFaltantes.push('nombre');        }        if (!datosCliente.direccion || datosCliente.direccion.trim() === '') {          camposFaltantes.push('direccion');        }        if (camposFaltantes.length > 0) {          let mensajePregunta = 'ğŸ‘‹ Â¡Hola! Veo que es tu primer pedido. Necesito algunos datos:\n\n';          if (camposFaltantes.includes('nombre')) {            mensajePregunta += 'â€¢ Â¿CuÃ¡l es tu nombre?\n';          }          if (camposFaltantes.includes('direccion')) {            mensajePregunta += 'â€¢ Â¿CuÃ¡l es tu direcciÃ³n de entrega?\n';          }          mensajePregunta += '\nPuedes enviar esta informaciÃ³n en tu siguiente mensaje. Por ahora, procesarÃ© tu pedido.';          try {            await whatsappBusinessService.enviarMensaje(telefono, mensajePregunta);          } catch (error) {            console.warn('âš ï¸ No se pudo enviar mensaje de solicitud de datos:', error.message);          }        }        const nombreCliente = datosCliente.nombre || `Cliente ${telefono.slice(-4)}`;        await clienteService.buscarOCrearCliente(telefono, nombreCliente);      }      if (!datosPedido.metodo_pago) {        try {          await whatsappBusinessService.enviarMensaje(            telefono,            'ğŸ’° Por favor, indica tu mÃ©todo de pago:\n\nâ€¢ Efectivo\nâ€¢ Tarjeta\nâ€¢ Transferencia\n\nEjemplo: "Pago en efectivo"\n\nPuedes enviarlo en tu siguiente mensaje. Por ahora, procesarÃ© tu pedido.'          );        } catch (error) {          console.warn('âš ï¸ No se pudo enviar mensaje de solicitud de mÃ©todo de pago:', error.message);        }        datosPedido.metodo_pago = 'efectivo';      }      const cliente = await clienteService.buscarOCrearCliente(telefono);      const productosMapeados = await this.mapearProductos(        datosPedido.productos,        productosJSON      );      let sucursalId = idSucursal;      if (!sucursalId) {        sucursalId = await this.determinarSucursalPorProductos(productosMapeados, mensaje);      }      let total = datosPedido.total;      if (!total || total === 0) {        total = productosMapeados.reduce((sum, p) => {          return sum + (p.precio * p.cantidad);        }, 0);      }      const datosPedidoFinal = {        id_cliente: cliente.id_cliente,        id_sucursal: sucursalId,        id_usuario_reportidor: null,         total: total,        pago: datosPedido.metodo_pago === 'efectivo' ? total : 0,        pendiente: datosPedido.metodo_pago === 'efectivo' ? 0 : total      };      const Pedido = require('../../orders/models/Pedido');      const PedidoProducto = require('../../../models/PedidoProducto');      const pedido = await Pedido.create(datosPedidoFinal);      for (const producto of productosMapeados) {        await PedidoProducto.create({          id_pedido: pedido.id_pedido,          id_producto: producto.id_producto        });      }      let mensajeEnviado = false;      try {        const mensajeConfirmacion = this.crearMensajeConfirmacion(pedido, cliente, productosMapeados, datosPedido);        await whatsappBusinessService.enviarMensaje(telefono, mensajeConfirmacion);        mensajeEnviado = true;      } catch (error) {        console.warn('No se pudo enviar mensaje de confirmaciÃ³n (WhatsApp Business API no configurado o error):', error.message);      }      return {        pedido: pedido.toJSON(),        cliente,        productos: productosMapeados,        mensaje_enviado: mensajeEnviado      };    } catch (error) {      console.error('Error al procesar pedido:', error);      try {        await whatsappBusinessService.enviarMensaje(          telefono,          'Lo sentimos, hubo un error al procesar tu pedido. Por favor, intenta de nuevo o contacta directamente.'        );      } catch (err) {        console.error('Error al enviar mensaje de error:', err);      }      throw error;    }  }  async validarDatosClienteNuevo(mensaje, telefono) {    const datosExtraidos = await geminiService.extraerDatosCliente(mensaje);    const camposFaltantes = [];    let mensajePregunta = 'ğŸ‘‹ Â¡Hola! Veo que es tu primer pedido. Necesito algunos datos:\n\n';    if (!datosExtraidos.nombre || datosExtraidos.nombre.trim() === '') {      camposFaltantes.push('nombre');      mensajePregunta += 'â€¢ Â¿CuÃ¡l es tu nombre?\n';    }    if (!datosExtraidos.direccion || datosExtraidos.direccion.trim() === '') {      camposFaltantes.push('direccion');      mensajePregunta += 'â€¢ Â¿CuÃ¡l es tu direcciÃ³n de entrega?\n';    }    if (camposFaltantes.length > 0) {      mensajePregunta += '\nPor favor, envÃ­a un mensaje con esta informaciÃ³n. Ejemplo:\n"Mi nombre es Juan PÃ©rez, mi direcciÃ³n es Calle Principal 123"';      try {        await whatsappBusinessService.enviarMensaje(telefono, mensajePregunta);      } catch (error) {        console.warn('âš ï¸ No se pudo enviar mensaje de solicitud de datos (token expirado o no configurado):', error.message);      }      return {        faltanDatos: true,        campos: camposFaltantes      };    }    if (datosExtraidos.nombre) {      await clienteService.buscarOCrearCliente(telefono, datosExtraidos.nombre);    }    return {      faltanDatos: false,      datos: datosExtraidos    };  }  async determinarSucursalPorProductos(productosMapeados, mensajeOriginal) {    const mensajeLower = mensajeOriginal.toLowerCase();    const nombresProductos = productosMapeados.map(p => p.nombre.toLowerCase()).join(' ');    const palabrasPolloFrito = ['pollo frito', 'pollo frito entero', 'pollo frito por piezas'];    const palabrasPolloGranel = ['alitas', 'alita', 'pollo a granel', 'pollo normal', 'muslo', 'pierna', 'pechuga', 'mollejas', 'molleja'];    const tienePolloFrito = palabrasPolloFrito.some(palabra =>       mensajeLower.includes(palabra) || nombresProductos.includes(palabra)    );    const tienePolloGranel = palabrasPolloGranel.some(palabra =>       mensajeLower.includes(palabra) || nombresProductos.includes(palabra)    );    let nombreSucursal;    if (tienePolloFrito) {      nombreSucursal = 'Pollo Frito';    } else if (tienePolloGranel) {      nombreSucursal = 'Pollo a Granel';    } else {      nombreSucursal = 'Pollo a Granel';    }    const sucursal = await Sucursal.findOne({      where: { nombre: nombreSucursal }    });    if (!sucursal) {      console.warn(`âš ï¸ No se encontrÃ³ sucursal con nombre "${nombreSucursal}", usando sucursal por defecto (ID: 1)`);      return 1;     }    console.log(`âœ… Sucursal asignada: ${sucursal.nombre} (ID: ${sucursal.id_sucursal})`);    return sucursal.id_sucursal;  }  async mapearProductos(productosMencionados, productosDisponibles) {    const productosMapeados = [];    for (const productoMencionado of productosMencionados) {      if (productoMencionado.id_producto) {        const producto = productosDisponibles.find(p => p.id_producto === productoMencionado.id_producto);        if (producto) {          productosMapeados.push({            id_producto: producto.id_producto,            nombre: producto.nombre,            cantidad: productoMencionado.cantidad || 1,            precio: producto.precio          });          continue;        }      }      const nombreBuscar = productoMencionado.nombre.toLowerCase();      const productoEncontrado = productosDisponibles.find(p => {        const nombreProducto = (p.descripcion || p.nombre || '').toLowerCase();        return nombreProducto.includes(nombreBuscar) || nombreBuscar.includes(nombreProducto);      });      if (productoEncontrado) {        productosMapeados.push({          id_producto: productoEncontrado.id_producto,          nombre: productoEncontrado.descripcion || productoEncontrado.nombre,          cantidad: productoMencionado.cantidad || 1,          precio: productoEncontrado.precio        });      } else {        console.warn(`Producto no encontrado en BD: ${productoMencionado.nombre}`);        productosMapeados.push({          id_producto: null,          nombre: productoMencionado.nombre,          cantidad: productoMencionado.cantidad || 1,          precio: 0         });      }    }    return productosMapeados;  }  formatearNotas(datosPedido) {    const notas = [];    if (datosPedido.notas) {      notas.push(datosPedido.notas);    }    if (datosPedido.direccion) {      notas.push(`DirecciÃ³n: ${datosPedido.direccion}`);    }    if (datosPedido.metodo_pago) {      notas.push(`MÃ©todo de pago: ${datosPedido.metodo_pago}`);    }    return notas.length > 0 ? notas.join(' | ') : null;  }  crearMensajeConfirmacion(pedido, cliente, productos, datosPedido = {}) {    const listaProductos = productos      .map(p => `â€¢ ${p.nombre} x${p.cantidad} - $${(p.precio * p.cantidad).toFixed(2)}`)      .join('\n');    const metodoPago = datosPedido.metodo_pago || 'No especificado';    const direccion = datosPedido.direccion ? `\nğŸ“ *DirecciÃ³n:* ${datosPedido.direccion}` : '';    return `âœ… *Pedido Confirmado*Hola ${cliente.nombre}!Tu pedido #${pedido.id_pedido} ha sido registrado:${listaProductos}*Total: $${parseFloat(pedido.total).toFixed(2)}*ğŸ’° *MÃ©todo de pago:* ${metodoPago}${direccion}ğŸ“¢ *Tu pedido ha sido notificado a la tienda.*Te contactaremos pronto para confirmar la entrega. Â¡Gracias por tu preferencia! ğŸ”`;  }}module.exports = new PedidoWhatsAppService();