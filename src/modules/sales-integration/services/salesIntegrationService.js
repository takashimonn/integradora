const salesIntegrationRepository = require('../repositories/salesIntegrationRepository');const XLSX = require('xlsx');const fs = require('fs');const path = require('path');class SalesIntegrationService {  async procesarExcelEleventa(filePath, idSucursal, fecha = null) {    try {      const sucursalExiste = await salesIntegrationRepository.verificarSucursal(idSucursal);      if (!sucursalExiste) {        throw new Error(`La sucursal con ID ${idSucursal} no existe`);      }      const workbook = XLSX.readFile(filePath);      const sheetName = workbook.SheetNames[0];      const worksheet = workbook.Sheets[sheetName];      const datos = XLSX.utils.sheet_to_json(worksheet, {         raw: false,         defval: null       });      if (!datos || datos.length === 0) {        throw new Error('El archivo Excel está vacío o no contiene datos válidos');      }      const resultado = this.procesarDatosVentas(datos, fecha);      const reporte = await salesIntegrationRepository.crearOActualizarReporte(        idSucursal,        resultado.fecha,        resultado.totalVentas      );      try {        if (fs.existsSync(filePath)) {          fs.unlinkSync(filePath);        }      } catch (error) {        console.warn('No se pudo eliminar el archivo temporal:', error.message);      }      return {        reporte: reporte.toJSON(),        resumen: {          fecha: resultado.fecha,          totalVentas: resultado.totalVentas,          totalRegistros: resultado.totalRegistros,          registrosProcesados: resultado.registrosProcesados        }      };    } catch (error) {      try {        if (fs.existsSync(filePath)) {          fs.unlinkSync(filePath);        }      } catch (err) {        console.warn('No se pudo eliminar el archivo temporal:', err.message);      }      throw error;    }  }  procesarDatosVentas(datos, fecha = null) {    let totalVentas = 0;    let fechaReporte = fecha;    let totalRegistros = datos.length;    let registrosProcesados = 0;    for (const fila of datos) {      try {        let monto = null;        if (fila['Importe'] !== undefined && fila['Importe'] !== null && fila['Importe'] !== '') {          monto = this.parsearNumero(fila['Importe']);        }        else if (fila['Total'] !== undefined && fila['Total'] !== null && fila['Total'] !== '') {          monto = this.parsearNumero(fila['Total']);        } else if (fila['Venta'] !== undefined && fila['Venta'] !== null && fila['Venta'] !== '') {          monto = this.parsearNumero(fila['Venta']);        } else if (fila['Monto'] !== undefined && fila['Monto'] !== null && fila['Monto'] !== '') {          monto = this.parsearNumero(fila['Monto']);        }        if (monto !== null && !isNaN(monto) && monto > 0) {          totalVentas += monto;          registrosProcesados++;        }        if (!fechaReporte) {          if (fila['Fecha'] !== undefined && fila['Fecha'] !== null && fila['Fecha'] !== '') {            fechaReporte = this.parsearFecha(fila['Fecha']);          } else if (fila['Date'] !== undefined && fila['Date'] !== null && fila['Date'] !== '') {            fechaReporte = this.parsearFecha(fila['Date']);          } else if (fila['Día'] !== undefined && fila['Día'] !== null && fila['Día'] !== '') {            fechaReporte = this.parsearFecha(fila['Día']);          }        }      } catch (error) {        console.warn('Error al procesar fila:', error.message, fila);      }    }    if (!fechaReporte) {      fechaReporte = new Date().toISOString().split('T')[0];    }    return {      fecha: fechaReporte,      totalVentas: totalVentas.toFixed(2),      totalRegistros,      registrosProcesados    };  }  parsearNumero(valor) {    if (valor === null || valor === undefined || valor === '') {      return null;    }    if (typeof valor === 'number') {      return valor;    }    if (typeof valor === 'string') {      let limpio = valor.trim();      limpio = limpio.replace(/\$/g, '');      limpio = limpio.replace(/,/g, '');      limpio = limpio.trim();      const numero = parseFloat(limpio);      if (isNaN(numero)) {        return null;      }      return numero;    }    return null;  }  parsearFecha(valor) {    if (!valor) {      return null;    }    if (typeof valor === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(valor)) {      return valor;    }    const fecha = new Date(valor);    if (!isNaN(fecha.getTime())) {      return fecha.toISOString().split('T')[0];    }    if (typeof valor === 'number') {      const fechaExcel = this.fechaDesdeNumeroExcel(valor);      return fechaExcel ? fechaExcel.toISOString().split('T')[0] : null;    }    return null;  }  fechaDesdeNumeroExcel(numero) {    try {      const fechaBase = new Date(1900, 0, 1);      const dias = Math.floor(numero) - 2;       fechaBase.setDate(fechaBase.getDate() + dias);      return fechaBase;    } catch (error) {      return null;    }  }  async obtenerReporte(idSucursal, fecha) {    const reporte = await salesIntegrationRepository.obtenerReportePorFecha(idSucursal, fecha);    if (!reporte) {      throw new Error('Reporte no encontrado');    }    return reporte.toJSON();  }  async obtenerReportes(idSucursal, fechaDesde = null, fechaHasta = null) {    const reportes = await salesIntegrationRepository.obtenerReportesPorSucursal(      idSucursal,      fechaDesde,      fechaHasta    );    return reportes.map(r => r.toJSON());  }  async verificarSincronizacionPendiente(idSucursal) {    return await salesIntegrationRepository.verificarSincronizacionPendiente(idSucursal);  }  async solicitarSincronizacion(idSucursal) {    const sucursalExiste = await salesIntegrationRepository.verificarSucursal(idSucursal);    if (!sucursalExiste) {      throw new Error(`La sucursal con ID ${idSucursal} no existe`);    }    const sincronizacion = await salesIntegrationRepository.marcarSincronizacionPendiente(idSucursal);    return sincronizacion.toJSON();  }  async recibirDatosVentas(idSucursal, fecha, totalVentas) {    if (!idSucursal) {      throw new Error('ID de sucursal es requerido');    }    if (!fecha) {      throw new Error('Fecha es requerida');    }    if (totalVentas === undefined || totalVentas === null) {      throw new Error('Total de ventas es requerido');    }    if (totalVentas < 0) {      throw new Error('Total de ventas no puede ser negativo');    }    const sucursalExiste = await salesIntegrationRepository.verificarSucursal(idSucursal);    if (!sucursalExiste) {      throw new Error(`La sucursal con ID ${idSucursal} no existe`);    }    const reporte = await salesIntegrationRepository.recibirDatosVentas(      idSucursal,      fecha,      totalVentas    );    return reporte.toJSON();  }}module.exports = new SalesIntegrationService();