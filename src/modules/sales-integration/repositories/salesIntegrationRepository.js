const Reporte = require('../../../models/Reporte');const Sucursal = require('../../../models/Sucursal');const Sincronizacion = require('../models/Sincronizacion');const { Op } = require('sequelize');const { sequelize } = require('../../../config/sequelize');class SalesIntegrationRepository {  async crearOActualizarReporte(idSucursal, fecha, totalVentas) {    try {      const reporteExistente = await Reporte.findOne({        where: {          id_sucursal: idSucursal,          fecha: fecha        }      });      if (reporteExistente) {        reporteExistente.total_ventas = parseFloat(totalVentas);        await reporteExistente.save();        return reporteExistente;      } else {        const nuevoReporte = await Reporte.create({          id_sucursal: idSucursal,          fecha: fecha,          total_ventas: parseFloat(totalVentas)        });        return nuevoReporte;      }    } catch (error) {      throw new Error(`Error al crear/actualizar reporte: ${error.message}`);    }  }  async obtenerReportePorFecha(idSucursal, fecha) {    try {      const reporte = await Reporte.findOne({        where: {          id_sucursal: idSucursal,          fecha: fecha        },        include: [{          model: Sucursal,          as: 'sucursal'        }]      });      return reporte;    } catch (error) {      throw new Error(`Error al obtener reporte: ${error.message}`);    }  }  async obtenerReportesPorSucursal(idSucursal, fechaDesde = null, fechaHasta = null) {    try {      const where = {        id_sucursal: idSucursal      };      if (fechaDesde && fechaHasta) {        where.fecha = {          [Op.between]: [fechaDesde, fechaHasta]        };      } else if (fechaDesde) {        where.fecha = {          [Op.gte]: fechaDesde        };      } else if (fechaHasta) {        where.fecha = {          [Op.lte]: fechaHasta        };      }      const reportes = await Reporte.findAll({        where,        include: [{          model: Sucursal,          as: 'sucursal'        }],        order: [['fecha', 'DESC']]      });      return reportes;    } catch (error) {      throw new Error(`Error al obtener reportes: ${error.message}`);    }  }  async verificarSucursal(idSucursal) {    try {      const sucursal = await Sucursal.findByPk(idSucursal);      return !!sucursal;    } catch (error) {      return false;    }  }  async verificarSincronizacionPendiente(idSucursal) {    try {      const sincronizacion = await Sincronizacion.findOne({        where: { id_sucursal: idSucursal }      });      if (!sincronizacion) {        return false;      }      return sincronizacion.pendiente === true;    } catch (error) {      return false;    }  }  async marcarSincronizacionPendiente(idSucursal) {    try {      const [sincronizacion, created] = await Sincronizacion.findOrCreate({        where: { id_sucursal: idSucursal },        defaults: {          id_sucursal: idSucursal,          pendiente: true        }      });      if (!created) {        sincronizacion.pendiente = true;        await sincronizacion.save();      }      return sincronizacion;    } catch (error) {      throw new Error(`Error al marcar sincronización pendiente: ${error.message}`);    }  }  async marcarSincronizacionCompletada(idSucursal) {    try {      const sincronizacion = await Sincronizacion.findOne({        where: { id_sucursal: idSucursal }      });      if (!sincronizacion) {        return await Sincronizacion.create({          id_sucursal: idSucursal,          pendiente: false,          ultima_sincronizacion: new Date()        });      }      sincronizacion.pendiente = false;      sincronizacion.ultima_sincronizacion = new Date();      await sincronizacion.save();      return sincronizacion;    } catch (error) {      throw new Error(`Error al marcar sincronización completada: ${error.message}`);    }  }  async recibirDatosVentas(idSucursal, fecha, totalVentas) {    try {      const reporte = await this.crearOActualizarReporte(idSucursal, fecha, totalVentas);      await this.marcarSincronizacionCompletada(idSucursal);      return reporte;    } catch (error) {      throw new Error(`Error al recibir datos de ventas: ${error.message}`);    }  }}module.exports = new SalesIntegrationRepository();