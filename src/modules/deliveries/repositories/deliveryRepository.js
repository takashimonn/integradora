const Reparto = require('../models/Reparto');const { Op } = require('sequelize');class DeliveryRepository {  async findAll(filtros = {}) {    const where = {};    if (filtros.activo !== undefined) {      where.activo = filtros.activo;    }    if (filtros.tipo) {      where.tipo = filtros.tipo;    }    if (filtros.clienteFrecuente !== undefined) {      where.clienteFrecuente = filtros.clienteFrecuente;    }    if (filtros.fechaDesde || filtros.fechaHasta) {      where.fecha = {};      if (filtros.fechaDesde) {        where.fecha[Op.gte] = filtros.fechaDesde;      }      if (filtros.fechaHasta) {        where.fecha[Op.lte] = filtros.fechaHasta;      }    }    if (filtros.fecha) {      where.fecha = filtros.fecha;    }    if (filtros.destino) {      where.destino = {        [Op.like]: `%${filtros.destino}%`      };    }    return await Reparto.findAll({      where,      order: [['fecha', 'DESC'], ['createdAt', 'DESC']]    });  }  async findById(id) {    return await Reparto.findByPk(id);  }  async create(datos) {    return await Reparto.create(datos);  }  async update(id, datos) {    const reparto = await Reparto.findByPk(id);    if (!reparto) {      throw new Error('Reparto no encontrado');    }    await reparto.update(datos);    return reparto.reload();  }  async delete(id) {    const reparto = await Reparto.findByPk(id);    if (!reparto) {      throw new Error('Reparto no encontrado');    }    await reparto.update({ activo: false });    return true;  }  async obtenerEstadisticas(fechaDesde, fechaHasta, tipo = null) {    const where = {      activo: true    };    if (tipo) {      where.tipo = tipo;    }    if (fechaDesde || fechaHasta) {      where.fecha = {};      if (fechaDesde) {        where.fecha[Op.gte] = fechaDesde;      }      if (fechaHasta) {        where.fecha[Op.lte] = fechaHasta;      }    }    const estadisticas = await Reparto.findAll({      where,      attributes: [        [Reparto.sequelize.fn('COUNT', Reparto.sequelize.col('id')), 'totalRepartos'],        [Reparto.sequelize.fn('SUM', Reparto.sequelize.col('cantidad')), 'totalCantidad'],        [Reparto.sequelize.fn('SUM', Reparto.sequelize.literal("CASE WHEN tipo = 'pollo_frito' THEN cantidad ELSE 0 END")), 'totalPolloFrito'],        [Reparto.sequelize.fn('SUM', Reparto.sequelize.literal("CASE WHEN tipo = 'pollo_fresco' THEN cantidad ELSE 0 END")), 'totalPolloFresco']      ],      raw: true    });    return estadisticas[0] || {      totalRepartos: 0,      totalCantidad: 0,      totalPolloFrito: 0,      totalPolloFresco: 0    };  }  async findByDestino(destino, filtros = {}) {    const where = {      destino: {        [Op.like]: `%${destino}%`      }    };    if (filtros.activo !== undefined) {      where.activo = filtros.activo;    }    if (filtros.tipo) {      where.tipo = filtros.tipo;    }    return await Reparto.findAll({      where,      order: [['fecha', 'DESC']]    });  }}module.exports = new DeliveryRepository();