const Usuario = require('../models/Usuario');const Sucursal = require('../models/Sucursal');const { generateToken } = require('../utils/jwt');const { ValidationError, UniqueConstraintError } = require('sequelize');const fs = require('fs');const path = require('path');class UsuarioService {  async registrarUsuario(datos) {    const { nombre, email, password } = datos;    if (!nombre || !email || !password) {      throw new Error('Todos los campos son requeridos: nombre, email, password');    }    const usuario = await Usuario.create({      nombre,      email,      password    });    const token = generateToken({      id_usuario: usuario.id_usuario,      email: usuario.email    });    return {      usuario: usuario.toJSON(),      token    };  }  async loginUsuario(email, password) {    if (!email || !password) {      throw new Error('Email y contraseña son requeridos');    }    const usuario = await Usuario.findOne({      where: { email }    });    if (!usuario) {      throw new Error('Credenciales inválidas');    }    if (!usuario.activo) {      throw new Error('Tu cuenta ha sido desactivada');    }    const isPasswordValid = await usuario.comparePassword(password);    if (!isPasswordValid) {      throw new Error('Credenciales inválidas');    }    const token = generateToken({      id_usuario: usuario.id_usuario,      email: usuario.email    });    return {      usuario: usuario.toJSON(),      token    };  }  async obtenerUsuarioPorId(id) {    const usuario = await Usuario.findByPk(id);    if (!usuario) {      throw new Error('Usuario no encontrado');    }    return usuario.toJSON();  }  async obtenerSucursalUsuario(idUsuario) {    const usuario = await Usuario.findByPk(idUsuario, {      include: [{        model: Sucursal,        as: 'sucursal',        attributes: ['id_sucursal', 'nombre', 'gerente', 'ubicacion', 'imagen']      }]    });    if (!usuario) {      throw new Error('Usuario no encontrado');    }    if (!usuario.id_sucursal) {      throw new Error('El usuario no tiene una sucursal asignada');    }    if (!usuario.sucursal) {      throw new Error('Sucursal no encontrada');    }    return usuario.sucursal.toJSON();  }  async actualizarImagenSucursal(idUsuario, imagenPath) {    const usuario = await Usuario.findByPk(idUsuario, {      include: [{        model: Sucursal,        as: 'sucursal'      }]    });    if (!usuario) {      throw new Error('Usuario no encontrado');    }    if (!usuario.id_sucursal) {      throw new Error('El usuario no tiene una sucursal asignada');    }    if (!usuario.sucursal) {      throw new Error('Sucursal no encontrada');    }    const imagenAnterior = usuario.sucursal.imagen;    await usuario.sucursal.update({ imagen: imagenPath });    if (imagenAnterior) {      this.eliminarImagen(imagenAnterior);    }    await usuario.sucursal.reload();    return usuario.sucursal.toJSON();  }  eliminarImagen(imagenPath) {    if (!imagenPath) return;    try {      if (imagenPath.startsWith('/uploads') || imagenPath.startsWith('uploads')) {        const rutaCompleta = path.join(__dirname, '../', imagenPath);        if (fs.existsSync(rutaCompleta)) {          fs.unlinkSync(rutaCompleta);        }      }    } catch (error) {      console.error('Error al eliminar imagen de sucursal:', error);    }  }  async actualizarUsuario(id, datos) {    const { nombre, email } = datos;    const usuario = await Usuario.findByPk(id);    if (!usuario) {      throw new Error('Usuario no encontrado');    }    if (nombre) usuario.nombre = nombre;    if (email) usuario.email = email;    await usuario.save();    return usuario.toJSON();  }  manejarError(error) {    if (error instanceof ValidationError) {      return {        tipo: 'VALIDACION',        mensaje: 'Error de validación',        errores: error.errors.map(err => ({          campo: err.path,          mensaje: err.message        }))      };    }    if (error instanceof UniqueConstraintError) {      return {        tipo: 'DUPLICADO',        mensaje: 'Este email ya está registrado'      };    }    return {      tipo: 'ERROR',      mensaje: error.message || 'Error desconocido'    };  }}module.exports = new UsuarioService();